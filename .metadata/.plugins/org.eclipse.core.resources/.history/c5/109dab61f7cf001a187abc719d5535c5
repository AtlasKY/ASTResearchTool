

import org.codehaus.groovy.ast.ClassCodeVisitorSupport
import org.codehaus.groovy.ast.ClassNode
import org.codehaus.groovy.ast.MethodNode
import org.codehaus.groovy.ast.*
import org.codehaus.groovy.ast.expr.BinaryExpression
import org.codehaus.groovy.ast.expr.ClosureExpression
import org.codehaus.groovy.ast.expr.ConstantExpression
import org.codehaus.groovy.ast.expr.DeclarationExpression
import org.codehaus.groovy.ast.expr.Expression
import org.codehaus.groovy.ast.expr.MapExpression
import org.codehaus.groovy.ast.expr.MethodCallExpression
import org.codehaus.groovy.ast.expr.NamedArgumentListExpression
import org.codehaus.groovy.ast.expr.PropertyExpression
import org.codehaus.groovy.ast.expr.TupleExpression
import org.codehaus.groovy.ast.expr.VariableExpression
import org.codehaus.groovy.ast.stmt.BlockStatement
import org.codehaus.groovy.ast.stmt.BreakStatement
import org.codehaus.groovy.ast.stmt.EmptyStatement
import org.codehaus.groovy.ast.stmt.ExpressionStatement
import org.codehaus.groovy.ast.stmt.ForStatement
import org.codehaus.groovy.ast.stmt.IfStatement
import org.codehaus.groovy.ast.stmt.ReturnStatement
import org.codehaus.groovy.ast.stmt.Statement
import org.codehaus.groovy.ast.stmt.WhileStatement
import org.codehaus.groovy.ast.Parameter
import org.codehaus.groovy.classgen.GeneratorContext
import org.codehaus.groovy.control.CompilePhase
import org.codehaus.groovy.control.SourceUnit
import org.codehaus.groovy.control.customizers.CompilationCustomizer
import org.codehaus.groovy.tools.shell.util.Logger
import org.codehaus.groovy.transform.GroovyASTTransformation
import org.codehause.groovyx.gpars.*


@GroovyASTTransformation(phase = CompilePhase.SEMANTIC_ANALYSIS)
class CTAnalysisAST extends CompilationCustomizer{
	
	
	Map allCmds
	Map allProps
	
	List allCommandsList
	List allPropsList
	List allCapsList	
	
	List handlers
	List devices
	
	Logger log
	
	public CTAnalysisAST(){
		
		super(CompilePhase.SEMANTIC_ANALYSIS)
		
		allCmds = new HashMap()
		allProps = new HashMap()
		
		allCommandsList = new ArrayList()
		allPropsList = new ArrayList()
		allCapsList = new ArrayList()
		
		handlers = new ArrayList<Handler>() //keep as arraylist for now for simplicity
		devices = new ArrayList();
			 
	}
	
	@Override
	void call(SourceUnit source, GeneratorContext context, ClassNode classNode) {
		
		MethodVisitor mv = new MethodVisitor()
		classNode.visitContents(mv)
		
		
	}
		
	class MethodVisitor extends ClassCodeVisitorSupport{
		
		public MethodVisitor() {
			println("MethodVisitor Constructor")
		}
		
		
		@Override
		void visitMethodCallExpression(MethodCallExpression mce) {
			
			println(mce.getMethodAsString())
			
			if(mce.getMethodAsString() == "subscribe") {
				
				List arglist = mce.getArguments().toList()
				
				if(arglist.get(0) instanceof VariableExpression){
					
					VariableExpression varex = (VariableExpression) arglist.get(0)
					
					println(varex.getName())
				}
				
				if(arglist.get(0) instanceof VariableExpression){
					
					VariableExpression varex = (VariableExpression) arglist.get(0)
					
					println(varex.getName())
				}
				
			}		
		}
		
		@Override
		protected SourceUnit getSourceUnit() {
			return null;
		}
	}
	
	class Handler {
		
		String name
		
		public Handler(String n) {
			name = n
		}
	}
	
	
}